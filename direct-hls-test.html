<!DOCTYPE html>
<html>
  <head>
    <title>Direct HLS Stream Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      video {
        width: 100%;
        background: #000;
      }
      .controls {
        margin: 20px 0;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 5px;
      }
      input {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
      }
      button {
        padding: 10px 15px;
        background: #0078d7;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #log {
        background: #f9f9f9;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 20px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  </head>
  <body>
    <h1>Direct HLS Stream Test</h1>

    <div class="controls">
      <h3>Enter HLS Stream URL</h3>
      <input
        type="text"
        id="streamUrl"
        value="http://localhost:8080/app/test-stream-123/llhls.m3u8"
      />
      <button onclick="loadStream()">Load Stream</button>
      <button onclick="stopStream()">Stop Stream</button>
    </div>

    <video id="video" controls autoplay muted></video>

    <div id="log">Logs will appear here...</div>

    <script>
      const video = document.getElementById("video");
      const streamUrlInput = document.getElementById("streamUrl");
      const logDiv = document.getElementById("log");
      let hls = null;

      function log(message) {
        console.log(message);
        const now = new Date().toISOString().substring(11, 19);
        logDiv.innerHTML = `[${now}] ${message}<br>` + logDiv.innerHTML;
      }

      function loadStream() {
        stopStream();

        const url = streamUrlInput.value.trim();
        log(`Loading stream from: ${url}`);

        if (Hls.isSupported()) {
          hls = new Hls({
            debug: true,
            liveDurationInfinity: true,
            lowLatencyMode: true,
            liveSyncDuration: 1.5,
            liveMaxLatencyDuration: 6,
          });

          // Setup debug logging for HLS events
          hls.on(Hls.Events.MEDIA_ATTACHED, function () {
            log("HLS.js attached to video element");
          });

          hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
            log(
              `Manifest parsed, found ${data.levels.length} quality level(s)`
            );
            video.play().catch((e) => log(`Play error: ${e.message}`));
          });

          hls.on(Hls.Events.ERROR, function (event, data) {
            log(`HLS error: ${data.type} - ${data.details}`);
            if (data.fatal) {
              log("Fatal error encountered, trying to recover...");
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  log("Network error, attempting to reconnect...");
                  hls.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  log("Media error, attempting to recover...");
                  hls.recoverMediaError();
                  break;
                default:
                  log("Fatal error, cannot recover");
                  stopStream();
                  break;
              }
            }
          });

          // Load source and attach to video
          hls.loadSource(url);
          hls.attachMedia(video);
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          // For Safari which has built-in HLS support
          log("Using native HLS support");
          video.src = url;
          video.addEventListener("loadedmetadata", function () {
            log("Metadata loaded, attempting to play");
            video.play().catch((e) => log(`Play error: ${e.message}`));
          });

          video.addEventListener("error", function () {
            log(`Video error: ${video.error.code}`);
          });
        } else {
          log("HLS is not supported in this browser");
        }
      }

      function stopStream() {
        log("Stopping stream");
        if (hls) {
          hls.destroy();
          hls = null;
        }
        video.pause();
        video.src = "";
        video.load();
      }

      // Initialize on page load
      log("Page loaded");
    </script>
  </body>
</html>
