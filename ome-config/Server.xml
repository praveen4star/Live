<?xml version="1.0" encoding="UTF-8"?>
<Server version="8" type="origin">
  <Name>OvenMediaEngine</Name>

  <!-- API Server Configuration - REQUIRED for LL-HLS -->
  <Managers>
    <API>
      <Enable>true</Enable>
      <Port>8081</Port>
      <WorkerCount>1</WorkerCount>
      <CrossDomains>
        <Url>*</Url>
      </CrossDomains>
    </API>
  </Managers>

  <Hosts>
    <Host>
      <Name>default</Name>
      <IP>*</IP>

      <VirtualHosts>
        <VirtualHost>
          <Name>default</Name>
          <Domain>*</Domain>
          
          <!-- Disable TLS for development -->
          <TLS>
            <Enable>false</Enable>
            <CertPath>origin_conf/cert.crt</CertPath>
            <KeyPath>origin_conf/cert.key</KeyPath>
            <ChainCertPath>origin_conf/cert.ca-bundle</ChainCertPath>
          </TLS>

          <Applications>
            <Application>
              <Name>app</Name>
              <Type>live</Type>
              
              <!-- RTMP Provider for ingest - REQUIRED -->
              <Providers>
                <RTMP>
                  <Enable>true</Enable>
                  <Port>1935</Port>
                  <WorkerCount>1</WorkerCount>
                </RTMP>
              </Providers>
              
              <Transcoder>
                <Enable>true</Enable>
                <Codec>
                  <Video>
                    <H264>
                      <Preset>faster</Preset>
                      <Profile>baseline</Profile>
                      <KeyFrameInterval>60</KeyFrameInterval>
                      <CBR>false</CBR>
                      <BFrames>0</BFrames>
                    </H264>
                  </Video>
                  <Audio>
                    <Opus>
                      <Bitrate>128000</Bitrate>
                      <Channel>2</Channel>
                      <Complexity>10</Complexity>
                      <Frame>20</Frame>
                    </Opus>
                    <AAC>
                      <Bitrate>128000</Bitrate>
                      <Channel>2</Channel>
                      <Samplerate>48000</Samplerate>
                    </AAC>
                  </Audio>
                </Codec>
                <Streams>
                  <!-- Bypass stream for original quality -->
                  <Stream>
                    <n>bypass_stream</n>
                    <Profiles>
                      <Profile>
                        <n>bypass_all</n>
                        <Video>
                          <Bypass>true</Bypass>
                        </Video>
                        <Audio>
                          <Bypass>true</Bypass>
                        </Audio>
                      </Profile>
                    </Profiles>
                  </Stream>
                  
                  <!-- ABR stream with multiple quality levels -->
                  <Stream>
                    <n>abr_stream</n>
                    <Profiles>
                      <!-- 720p profile for LL-HLS -->
                      <Profile>
                        <n>720p</n>
                        <Video>
                          <Codec>H264</Codec>
                          <Width>1280</Width>
                          <Height>720</Height>
                          <Bitrate>2500000</Bitrate>
                          <Framerate>30</Framerate>
                        </Video>
                        <Audio>
                          <Codec>AAC</Codec>
                          <Bitrate>128000</Bitrate>
                          <Samplerate>48000</Samplerate>
                          <Channel>2</Channel>
                        </Audio>
                      </Profile>
                      
                      <!-- 480p profile -->
                      <Profile>
                        <n>480p</n>
                        <Video>
                          <Codec>H264</Codec>
                          <Width>854</Width>
                          <Height>480</Height>
                          <Bitrate>1200000</Bitrate>
                          <Framerate>30</Framerate>
                        </Video>
                        <Audio>
                          <Codec>AAC</Codec>
                          <Bitrate>128000</Bitrate>
                          <Samplerate>48000</Samplerate>
                          <Channel>2</Channel>
                        </Audio>
                      </Profile>
                    </Profiles>
                  </Stream>
                </Streams>
              </Transcoder>

              <!-- Recording for VOD -->
              <Recording>
                <Enable>true</Enable>
                <FilePath>/recordings</FilePath>
                <InfoPath>/recordings</InfoPath>
                <FileExtension>mp4</FileExtension>
                <RecordingInterval>60000</RecordingInterval>
                <Schedule>
                  <Enabled>false</Enabled>
                </Schedule>
              </Recording>

              <Publishers>
                <WebRTC>
                  <Enable>true</Enable>
                  <Port>3333</Port>
                  <Timeout>30000</Timeout>
                  <CrossDomains>
                    <Url>*</Url>
                  </CrossDomains>
                  <SessionTimeout>180000</SessionTimeout>
                  <CandidatePort>
                    <Port>10000/tcp</Port>
                    <Port>10000-10004/udp</Port>
                  </CandidatePort>
                </WebRTC>

                <LLHLS>
                  <Enable>true</Enable>
                  <Port>8080</Port>
                  <SegmentDuration>2</SegmentDuration>
                  <ChunkDuration>0.5</ChunkDuration>
                  <SegmentCount>5</SegmentCount>
                  <CrossDomains>
                    <Url>*</Url>
                  </CrossDomains>
                </LLHLS>
              </Publishers>
            </Application>
          </Applications>
        </VirtualHost>
      </VirtualHosts>
    </Host>
  </Hosts>

  <Bind>
    <Managers>
      <API>
        <Port>8081</Port>
      </API>
    </Managers>

    <Providers>
      <RTMP>
        <Port>1935</Port>
        <WorkerCount>1</WorkerCount>
      </RTMP>
    </Providers>

    <Publishers>
      <LLHLS>
        <Port>8080</Port>
        <WorkerCount>2</WorkerCount>
      </LLHLS>
      <WebRTC>
        <Port>3333</Port>
        <WorkerCount>1</WorkerCount>
      </WebRTC>
    </Publishers>

    <WebRTC>
      <IceCandidates>
        <IceCandidate>*:10000-10004/udp</IceCandidate>
      </IceCandidates>
      <TcpRelay>
        <Listen>*:3478</Listen>
        <TcpForwarding>true</TcpForwarding>
        <Protocol>tcp</Protocol>
      </TcpRelay>
    </WebRTC>
  </Bind>
</Server>